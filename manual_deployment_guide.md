# AWS Lambda 手動デプロイ手順

このガイドでは、AWS SAMやCLIなどの自動化ツールを使わず、AWSマネジメントコンソール（Webブラウザ）を使って手動でバックエンドを構築・デプロイする手順を説明します。

## 前提条件

- AWSアカウントを持っていること
- Node.js がローカル環境にインストールされていること
- 以下の情報が決まっていること
  - 送信元メールアドレス（SES検証済みであること）
  - 通知先メールアドレス

---

## 1. 準備：デプロイパッケージの作成

LambdaにアップロードするためのZIPファイルを作成します。

1. **コマンドプロンプト**（またはPowerShell/ターミナル）を開き、`backend` ディレクトリに移動します。

   ```bash
   cd c:\Users\ryouk\buten\backend
   ```

2. **依存パッケージのインストール**
   `package.json` に記載されたライブラリをインストールします。

   ```bash
   npm install
   ```

   ※ これにより `node_modules` フォルダが作成されます。

3. **ZIPファイルの作成**

   **【推奨】PowerShellコマンドで作成する場合**:
   以下のコマンドをコピーして実行してください。

   ```powershell
   Compress-Archive -Path handler.js, package.json, node_modules -DestinationPath function.zip -Force
   ```

   **手動で作成する場合**:
   以下のファイルとフォルダをすべて選択し、右クリック → 「送る」 → 「圧縮（zip形式）フォルダー」を選択します。
   - `handler.js`
   - `package.json`
   - `node_modules` (フォルダごと)

   **重要**: `backend` フォルダそのものではなく、**中身のファイル群**を選択して圧縮してください。ZIPファイル直下に `handler.js` がある状態にする必要があります。
   （ファイル名例: `function.zip`）

---

## 2. DynamoDB（データベース）の作成

お問い合わせデータを保存するテーブルを作成します。

1. AWSコンソールで **DynamoDB** サービスを開きます。
2. 「**テーブルの作成**」をクリックします。
3. 以下の通り設定します。
   - **テーブル名**: `ButenContactSubmissions`
   - **パーティションキー**: `id` (文字列)
   - その他の設定はデフォルトのままでOK
4. 「**テーブルの作成**」をクリックします。

---

## 3. SES（メール配信）の設定

通知メールを送るための設定です。

1. AWSコンソールで **Amazon SES** サービスを開きます。
2. 左メニューの **Identities**（ID）をクリックします。
3. 「**ID の作成**」をクリックします。
4. **ID タイプ**: 「Eメールアドレス」を選択。
5. **メールアドレス**: 送信元として使うメールアドレス（例: `info@wadaiko-buten.com`）を入力。
6. 「**ID の作成**」をクリック。
7. 入力したメールアドレスに確認メールが届くので、リンクをクリックして承認します。
8. **重要**: テスト通知を受け取るメールアドレスも同様に登録・承認してください（SESがサンドボックスモードの場合、送信先も検証済みである必要があります）。

---

## 4. Lambda関数の作成

1. AWSコンソールで **Lambda** サービスを開きます。
2. 「**関数の作成**」をクリックします。
3. 以下の通り設定します。
   - **オプション**: 「一から作成」
   - **関数名**: `ButenContactFunction`
   - **ランタイム**: `Node.js 20.x`
   - **アーキテクチャ**: `x86_64`
   - **アクセス権限**: 「基本的なLambdaアクセス権限で新しいロールを作成」
4. 「**関数の作成**」をクリックします。

### コードのアップロード

1. 作成された関数の画面で、「**コード**」タブを開きます。
2. 「**アップロード元**」ボタン → 「**.zipファイル**」を選択します。
3. 手順1で作成した `function.zip` をアップロードします。

### 環境変数の設定

1. 「**設定**」タブ → サイドメニューの「**環境変数**」を選択します。
2. 「**編集**」をクリックし、以下の変数を追加します。
   - キー: `TABLE_NAME` / 値: `ButenContactSubmissions`
   - キー: `NOTIFICATION_EMAIL` / 値: (通知先メールアドレス)
   - キー: `SENDER_EMAIL` / 値: (送信元メールアドレス)
3. 「**保存**」をクリックします。

### 権限（IAMロール）の設定

LambdaがDynamoDBとSESにアクセスできるようにします。

1. 「**設定**」タブ → サイドメニューの「**アクセス権限**」を選択します。
2. 「**実行ロール**」の下にあるロール名（リンク）をクリックしてIAMコンソールを開きます。
3. IAMコンソールの「**許可**」タブで「**許可を追加**」→「**ポリシーをアタッチ**」を選択します。
4. 以下の2つのポリシーを検索してチェックを入れ、「**許可を追加**」をクリックします。
   - `AmazonDynamoDBFullAccess` (または必要な権限のみに絞ったポリシー)
   - `AmazonSESFullAccess` (または必要な権限のみに絞ったポリシー)
     ※ 本番環境ではより厳密なポリシーを作成することが推奨されますが、手動設定の簡易化のためFullAccessとしています。

---

## 5. API Gateway（REST API）の作成

LambdaをWebから呼び出せるようにします。お問い合わせフォームの構成に合わせて、**REST API** を使用します。

1. AWSコンソールで **API Gateway** サービスを開きます。
2. 一覧から「**REST API**」（公開・非公開などと書かれているもの）を探し、「**構築**」をクリックします。
   ※ 注意: 「REST API プライベート」や「HTTP API」を選ばないようにしてください。
3. **APIの作成**:
   - プロトコルを選択: `REST`
   - 「**新しい API**」を選択
   - **API名**: `ButenContactAPI`
   - 「**API の作成**」をクリック。

### リソースの作成

1. 作成されたAPIの画面で、「**アクション**」→「**リソースの作成**」を選択します。
2. **リソース名**: `contact`
3. **リソースパス**: `contact`
4. 「**API Gateway CORS を有効にする**」にチェックを入れます（重要）。
5. 「**リソースの作成**」をクリック。

### メソッドの作成

1. 作成した `/contact` リソースを選択した状態で、「**アクション**」→「**メソッドの作成**」を選択します。
2. ドロップダウンから `POST` を選択し、チェックマークをクリックして決定します。
3. **セットアップ**:
   - **統合タイプ**: `Lambda 関数`
   - **Lambda プロキシ統合の使用**: **チェックを入れる**（非常に重要です。これがないと正しく動作しません）
   - **Lambda 関数**: `ButenContactFunction` （先ほど作成した関数名を入力）
4. 「**保存**」→「**OK**」をクリック。

### APIのデプロイ

作成したAPIを公開状態にします。

1. 「**アクション**」→「**API のデプロイ**」を選択します。
2. **デプロイされるステージ**: `[新しいステージ]` を選択。
3. **ステージ名**: `prod` （または `v1` など任意）
4. 「**デプロイ**」をクリック。

### URLの確認

1. 左メニューの「**ステージ**」をクリックし、作成した `prod` ステージを選択します。
2. 画面上部に表示される「**URL の呼び出し**」がAPIのベースURLです。
   例: `https://xxxxxx.execute-api.ap-northeast-1.amazonaws.com/prod`
3. これにリソース名 `/contact` を足したものが、Webサイトで使用するURLになります。
   例: `https://xxxxxx.execute-api.ap-northeast-1.amazonaws.com/prod/contact`

---

## 6. フロントエンドの更新

1. `contact.html` (または `home.js` / `main.js` 等、APIを呼び出している箇所) を開きます。
2. リクエスト送信先のURLを、上記で取得したAPI GatewayのURL書き換えます。
3. フロントエンドを更新（S3に再アップロードなど）します。

以上で手動デプロイは完了です。
